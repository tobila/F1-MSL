<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Formula 1 - Visualization</title>

    <!-- Bootstrap -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link href="styles.css" rel="stylesheet">
</head>

<body data-spy="scroll" data-target=".navbar" data-offset="50">
  <nav class="navbar navbar-dark navbar-expand-lg navbar-light bg-dark">
    <span class="navbar-brand" >Formula 1 - Visualization</span>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item active">
          <a class="nav-link" href="index.html">Start page <span class="sr-only">(current)</span></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="wm.html">World Champions</a>
        </li>

      </ul>

    </div>
  </nav>

    <br><br>


    <div class="container">

      <div class="card text-center">
        <div class="card-header">
          Lap times
        </div>
        <div class="container-fluid">
          <p class="alert alert-success" style="margin-left:2%; margin-right:2%; margin-top:10px">
          The heatmap shows an overview of all tracks that have been driven since 2004.<br>
          The color values indicate the fastest lap time in milliseconds that was driven to the corresponding track and year during the race. <br>
          As a guideline: 100,000 milliseconds are 1 minute and 40 seconds. Further details about a race can be viewed by clicking on a datapoint of the heatmap.</p>
          <hr>
        </div>
        <div id="mainView">

          <!-- <img src="img/3d-linechart.png"> -->
        </div>
      </div>

      <!-- <br><br>

      <div class="card text-center">
        <div class="card-header">
          Parameter-Settings (Parameter-View)
        </div>
        <div class="card-body">
          <div class="form-row">
            <div class="form-group col-md-4">
              <label for="customRange3">Year Range</label>
              <input type="range" class="custom-range" min="0" max="5" step="0.5" id="customRange3">
            </div>
            <div class="form-group col-md-1">
              &nbsp;
            </div>
            <div class="form-group col-md-4">
              <label for="inputState">Race</label>
              <select id="inputState" class="form-control">
                <option selected>Choose...</option>
                <option>...</option>
              </select>
            </div>
            <div class="form-group col-md-1">
              &nbsp;
            </div>
            <div class="form-group col-md-2">
              <label for="inputZip">Year</label>
              <select id="inputState" class="form-control">
                <option selected>Choose...</option>
                <option>...</option>
              </select>
            </div>
          </div>
        </div>
      </div> -->

      <br><br>

      <div class="card text-center detailsWrapper" style="height: 2600px;">
        <div class="card-header" id="detailsHeader">
          Select a data point in the heatmap to show detailed information
        </div>
        <p class="alert alert-success" style="margin-left:2%; margin-right:2%; margin-top:10px">
          The following visualization shows the overlap between the grid and the final position.<br>
          Each driver is shown as a dash and has a unique angle of inclination. While the strokes on the grid do not have any overlaps, the final position uses the inclinations to show which changes occurred during the race.
        </p>
        <br><br>
        <h5 class="card-title">End position</h5>
        <div>
          <button id="reloadShuffle" type="button" class="btn btn-info" aria-label="Left Align">
            <span class="glyphicon glyphicon-star" aria-hidden="true"></span> Repeat visualization
          </button>

          <!-- <button class="btn btn-primary" >Hallo</button> -->
        </div>
        <div class="card-body" id="liveShuffle">
          <b>Select a data point in the heatmap to show detailed information</b>
        </div>
        <hr>
        <p class="alert alert-success" style="margin-left:2%; margin-right:2%">
          The visualization of the race shows all changes of position during the race.<br>
          The color scheme begins at dark green (race winner) and interpolated to dark red (last of the race). The colors are matched with the lap times linechart. There is also a legend, which color is associated to a driver.
        </p>
        <h5 class="card-title">Race-progress</h5>
        <div class="card-body" id="lapSort">
          <b>Select a data point in the heatmap to show detailed information</b>
        </div>
        <hr>
        <p class="alert alert-success" style="margin-left:2%; margin-right:2%">
          The lap times line chart shows all lap times of all drivers in a race.<br>
          By double-clicking on a driver in the legend, his lineplot can be displayed individually. Hiding individual drivers can be done by simply clicking on the name.
        </p>
        <h5 class="card-title">Lap times Linechart</h5>
        <div class="card-body" id="linePlott">
          <b>Select a data point in the heatmap to show detailed information</b>
        </div>
      </div>
    </div>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.bundle.min.js" integrity="sha384-pjaaA8dDz/5BgdFUPX6M/9SUZv4d12SUPF0axWc+VRZkx5xU3daN+lYb49+Ax+Tl" crossorigin="anonymous"></script>

    <script src="//d3js.org/d3.v3.min.js"></script>
    <script src="cubehelix.js"></script>

    <script>
      var globalLiveShuffle = [];
    </script>


    <script>
  function lapSort(jsonInput) {
    document.getElementById("lapSort").innerHTML = "";
    if(jsonInput==undefined){
        document.getElementById("lapSort").innerHTML = "No data available";
      console.log(' no data')
    }
    else{
    d3.selectAll("#lapSort > *").remove(); //clear plott
    console.log(jsonInput)

        var arrays = lapOrdersJsonToArrays(jsonInput);
        // var n = arrays[0].length;
        var n = jsonInput.laps.length + 1

        var roundN = arrays.length;
        console.log(roundN+" Runden")

        var elements = d3.range(n).map(function(i) { return {value: i, indexes: []}; });
        // console.log(arrays)

    var color = d3.scale.cubehelix()
        .domain([0, n / 2, n - 1])
        .range([d3.hsl(160, 1, .4), d3.hsl(60, 1, .9), d3.hsl(-40, 1, .4)]);

    arrays.forEach(function(array, t) {
      array.forEach(function(value, i) {
      try {
        elements[value].indexes.push({time: t, index: i});
      }
      catch(TypeError) {
        // console.log('undef')
      }

      });
    });

    var margin = {top: 40, right: 40, bottom: 50, left: 40},
        width = 600 - margin.left - margin.right,
        height = 800 - margin.top - margin.bottom;


    var x = d3.scale.ordinal()
        .domain(d3.range(n))
        .rangePoints([0, width]);

    var y = d3.scale.ordinal()
        .domain(d3.range(arrays.length))
        .rangePoints([0, height]);

    var line = d3.svg.line()
        .interpolate(interpolateLine)
        .x(function(d) { return x(d.index); })
        .y(function(d) { return y(d.time); });

    var svg = d3.select("#lapSort").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
      .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    svg.append("g")
        .attr("class", "lineRound")
      .selectAll("path")
        .data(elements)
      .enter().append("path")
        .style("stroke", function(d) { return color(d.value); })
        .attr("d", function(d) { return line(d.indexes); })
      .select(function() { return this.parentNode.insertBefore(this.cloneNode(false), this); })
        .attr("class", "line-halo")
        .style("stroke", null);
    svg.append("text")
        .attr("x", (0))
        .attr("y", (height+20))
        .attr("text-anchor", "middle")
        .style("font-size", "16px")
        // .style("text-decoration", "underline")
        .text("1st");
    svg.append("text")
        .attr("x", (width))
        .attr("y", (height+20))
        .attr("text-anchor", "middle")
        .style("font-size", "16px")
        // .style("text-decoration", "underline")
        .text("last");
    svg.append("text")
        .attr("x", (width/2))
        .attr("y", (height+40))
        .attr("text-anchor", "middle")
        .style("font-size", "16px")
        // .style("text-decoration", "underline")
        .text((n-1)+" drivers participated");
    svg.append("text")
      .attr("x", (-15))
      .attr("y", (-8))
      .attr("text-anchor", "middle")
      .style("font-size", "16px")
      .text("Round");
    for (var i = 1; i < roundN; ++i) {
      if (i % 5 == 0){    // nur jeder 5. runde wird angezeigt. 
        svg.append("text")
          .attr("x", (-20))
          .attr("y", (i*((height+10)/roundN)+1))
          .attr("text-anchor", "middle")
          .style("font-size", "10px")
          .text(i);
        }
    }


    function interpolateLine(points) {
      var p0 = points[0],
          x0 = p0[0],
          y0 = p0[1],
          path = [p0];
      for (var i = 1, n = points.length, p1, x1, y1; i < n; ++i) {
        p1 = points[i];
        x1 = p1[0];
        y1 = p1[1];
        path.push("V", (y0 * 2 + y1) / 3, "L", x1, ",", (y0 + y1 * 2) / 3, "V", y1);
        x0 = x1;
        y0 = y1;
      }
      return path.join("");
    }

    function lapOrdersJsonToArrays(jsonInput)
    {
      var rounds = [],
      n = jsonInput.lapCount;
      for (i = 0; i < n+1; i++) {
        var round = []
        var rank = 0
        jsonInput.laps.forEach(function(driver) {
          rank +=1
          round[driver.placing[i]] = rank
        // console.log(rank)
        round.push()
        });
        // console.log(round)
        rounds.push(round)
      }
      return rounds
    }
    d3.select(self.frameElement).style("height", height + margin.top + margin.bottom + "px");
    }
  }
    </script>

    <script>
    function liveShuffle(end) {
      document.getElementById("liveShuffle").innerHTML = "";
      if(end==undefined){
        document.getElementById("liveShuffle").innerHTML = "No data available";
        console.log('liveShuffle no data')
      }
      else{
          var n = end.length;
          // console.log("liveShuffle(), receiving: [" + end +"], n="+ n)
          d3.selectAll("#liveShuffle > *").remove(); //clear plott
          if(end.includes("0")) console.log("zero based")

          if((Math.max(... end)>n) || (Math.max(... end)==n && end.includes("0"))){
            console.log("fehlerhafte daten: mindestens 1 platz ist höher als die anzahl der rennteilnehmer")
            document.getElementById("liveShuffle").innerHTML = "No data available";
          }
          else if (Math.max(... end)<(n-1)){
            console.log("fehlerhafte daten: der letzte platz ist geringer als die anzahl der rennteilnehmer")
            document.getElementById("liveShuffle").innerHTML = "No data available";
          }
          else{
          var array = d3.range(n),
          copys = shuffle(end.slice()).reverse();

          var margin = {top: 35, right: 40, bottom: 70, left: 40},
              width = 400 - margin.left - margin.right,
              height = 275 - margin.top - margin.bottom;

          var y = d3.scale.ordinal()
            .domain([1, 0])
            .rangeRoundBands([height, 0], .3);

          var x = d3.scale.ordinal()
              .domain(d3.range(n))
              .rangePoints([0, width]);

          var a = d3.scale.linear()
              .domain([0, n - 1])
              .range([-45, 45]);

          var svg = d3.select("#liveShuffle").append("svg")
              .attr("width", width + margin.left + margin.right)
              .attr("height", height + margin.top + margin.bottom)
              .append("g")
              .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

          var line = svg.append("g")
              .attr("class", "line")
            .selectAll("line")
              .data(array.map(function(v, i) {
              return {
                value: v,
                index: i,
                array: 0
              };
            }))
            .enter().append("line")
              .attr("transform", transform)
              .attr("y2", -y.rangeBand());

            var line0 = line[0],
                line1 = new Array(n);

            var transition = d3.transition()
                .duration(200)
                .each("start", function start() {
                  var copy = copys.pop(),
                      i = copy[0], //from
                      j = copy[1]; //to
                      // console.log("start: " +i)
                      // console.log("end: "+ j)
                  var e = line1[j] = line0[i],
                      d = e.__data__;
                      d.index = j;
                      d.array = (d.array + 1) & 1;

                  transition.each(function() { d3.select(e).transition().attr("transform", transform); });
                  if (copys.length) transition = transition.transition().each("start", start);
                });

          function transform(d) {
            return "translate(" + x(d.index) + "," + y(d.array) + ")rotate(" + a(d.value) + ")";
          }

          function shuffle(mix) {
            var copys = [],
                m = mix.length;
            while (m) {
            p = mix[(m--)-1];
            // console.log("Von: p = " +p)
            // console.log("Nach: m = "+ m)
            copys.push([p - !(mix.includes("0")), m ]); // -!(mix.includes("0") this converts 1 (one) based indexing
            }
            return copys;
          }
          svg.append("text")
              .attr("x", (0))
              .attr("y", height - (margin.top ))
              .attr("text-anchor", "middle")
              .style("font-size", "16px")
              // .style("text-decoration", "underline")
              .text("1st");
          svg.append("text")
              .attr("x", (width))
              .attr("y", height - (margin.top ))
              .attr("text-anchor", "middle")
              .style("font-size", "16px")
              // .style("text-decoration", "underline")
              .text("last");
        }
      }
  }

  function plotLineChart(data, places){
    document.getElementById("linePlott").innerHTML = "";
    if(data==undefined){
      document.getElementById("linePlott").innerHTML = "No data available";
      console.log('linePlot no data')
    }
    else{

      function getEndPlaceOf(name) //finden der Endposition
      {
        var place;
        for (i = 0; i < places.laps.length; i++) {
          var driver = places.laps[i];
          if(driver.name == name){
              // console.log(name+", Endposition: "+i)
              return i;
            }
      }

    }


        var n = data.length;
      var color = d3.scale.cubehelix()
          .domain([0, n / 2, n - 1])
          .range([d3.hsl(160, 1, .4), d3.hsl(60, 1, .9), d3.hsl(-40, 1, .4)]);


      colors = [
      '#000000' ,'#000033',	'#000066',	'#000099',	'#0000cc',	'#0000ff',
      '#003300'	,'#003333',	'#003366',	'#003399',	'#0033cc',	'#0033ff',
      '#006600'	,'#006633',	'#006666',	'#006699',	'#0066cc',	'#0066ff',
      '#660000'	,'#660033',	'#660066',	'#660099',	'#6600cc',	'#6600ff',
      '#663300'	,'#663333',	'#663366',	'#663399',	'#6633cc',	'#6633ff',
      '#666600'	,'#666633',	'#666666',	'#666699',	'#6666cc',	'#6666ff',
      '#cc0000'	,'#cc0033',	'#cc0066',	'#cc0099',	'#cc00cc',	'#cc00ff',
      '#cc3300'	,'#cc3333',	'#cc3366',	'#cc3399',	'#cc33cc',	'#cc33ff',
      '#cc6600'	,'#cc6633',	'#cc6666',	'#cc6699',	'#cc66cc',	'#cc66ff'
      ]
      var newData =[]
      // cosmetic settins
      for (i in data) {
          var d= data[i],
          name = d.name,

          rounds = [],
          n = d.y.length;
          var c;
          if(places==undefined){
            c= colors[i]
          }else{
            var place = getEndPlaceOf(d.name);
            c= color(place); //farbe aus platzierung auslesen
          }

          for (var i = 1; i <= n; i++) {
             rounds.push(i);
          }
          var trace = {
            type: "scatter",
            mode: "lines",
            name: name,
            y: d.y,
            x: rounds,
            line: {
              color: c,
              dash: 'solid',
              width: 3
          }
          }
        newData.push(trace)
      }
          // console.log(newData)
      var layout = {
        autosize: true,
        // width: 500,
        height: 700,
        // title: 'Streckenzeiten',

        xaxis: {
            autorange: true,
            range: ['2', '4'],
            rangeselector: {buttons: [
                {
                  count: 1,
                  label: '1m',
                  step: 'month',
                  stepmode: 'backward'
                },
                {
                  count: 6,
                  label: '6m',
                  step: 'month',
                  stepmode: 'backward'
                },
                {step: 'all'}
              ]},
            rangeslider: {range: ['1', '5']},
            title: {text:'Lap count'}

            // type: 'date'
          },
        yaxis: {
          title:  {text:'Laptime [ms]'},
          type: 'log',
          autorange: true
        },
        legend: {
          y: 0.5,
          // traceorder: 'reversed',
          font: {
            size: 16
          }
        }
      };
      Plotly.newPlot('linePlott', newData, layout);
    }
  }

    </script>

    <script>
      $.get('/fastestLapsHeatmap', {}, function(data){
        var xValues = data.year;
        var yValues = data.raceNames;
        var zValues = data.fastestLaps;
        // console.log(yValues.length);
        // console.log(xValues.length);
        var laptimesPlot = document.getElementById('mainView');
        var colorscaleValue = [
          [0, '#4D9603'],
          [1, '#E6FBA0']
        ];
        var data = [{
          x: xValues,
          y: yValues,
          z: zValues,
          type: 'heatmap',
          zmin:65000,
          zmax:120000,
          colorscale: colorscaleValue,
          showscale: true
        }];
        var layout = {
          title: 'Fastest Lap times in milliseconds',
          autosize: true,
          // width: 500,
          height: 1000,
          xaxis: {
            ticks: '',
            side: 'top'
          },
          yaxis: {
            automargin: true
          }
        };
        Plotly.newPlot('mainView', data, layout);

        laptimesPlot.on('plotly_click', function(data){
          var clickData = data.points[0];
          var getYear = clickData.pointIndex[1];
          var getRace = clickData.pointIndex[0];
          var race = yValues[getRace];
          var year = xValues[getYear];
          $.get('/getDetailsViewData', {raceIndex: getRace, yearIndex: getYear}, function(data){
            var detailsHeader = document.getElementById("detailsHeader");
            // HIER FUNKTIOSAUFRUF FISHER-YATESSHUFFLE:
            // Sortiertes Startarray: data.start
            // Vermischtes Endarray: data.end
            console.log("Clicked at: "+race+" "+year)

            detailsHeader.innerHTML = "Race details: "+race+" "+year;
            window.location.href = "#detailsHeader";
            var endPos = data.end;
            var lapT = data.laptimes;
            var places = data.places;
            globalLiveShuffle = data.end;


            lapSort(places)
            liveShuffle(endPos)
            plotLineChart(lapT,places)
            // if (endPos!=undefined && endPos.length > 0){
            //   liveShuffle(endPos)
            //   plotLineChart(lapT)
            //   // console.log(lapT)
            // }
            // else console.log("no data")
          });
        });
      });

      $('#reloadShuffle').click(function() {
        liveShuffle(globalLiveShuffle);
      });


    </script>


</body>
</html>
